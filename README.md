# Dancehall Telegram Bot

Telegram-–±–æ—Ç –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ dancehall-–≤–∏–¥–µ–æ –Ω–∞ **aiogram 3.x** + SQLite.

## –ß—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ

- –î–æ–±–∞–≤–ª–µ–Ω–∞ production-—Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —á–µ—Ä–µ–∑ SQLite-—Ç–∞–±–ª–∏—Ü—É `users`.
- –†–æ–ª–∏ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏:
  - `ADMIN` ‚Äî ID –∏–∑ `ADMIN_IDS`/`ADMIN_ID` –≤ `.env`.
  - `MEMBER` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ `users`, –Ω–µ –∑–∞–±–∞–Ω–µ–Ω, –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞.
  - `EXPIRED` / `BANNED` / `UNKNOWN` ‚Äî –¥–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç.
- –î–ª—è `EXPIRED`, `BANNED`, `UNKNOWN` –≤—Å–µ–≥–¥–∞ –µ–¥–∏–Ω—ã–π –æ—Ç–≤–µ—Ç: **¬´–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É @deeear_polly¬ª**.
- –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω-–º–µ–Ω—é: **¬´üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏¬ª**.
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã FSM-—Å—Ü–µ–Ω–∞—Ä–∏–∏:
  - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
  - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ä–æ–∫–∞,
  - –±–∞–Ω/—Ä–∞–∑–±–∞–Ω,
  - —É–¥–∞–ª–µ–Ω–∏–µ,
  - —Å–ø–∏—Å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π).

## ENV-–∫–æ–Ω—Ñ–∏–≥

–°–æ–∑–¥–∞–π—Ç–µ `.env`:

```env
BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞
DB_PATH=/app/data/dancehall.db

# –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –±–æ—Ç–∞ (–æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ)
ADMIN_ID=123456789
# ADMIN_IDS=123456789,987654321

# ID vault-–∫–∞–Ω–∞–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ; fallback: STORAGE_CHAT_ID)
VAULT_CHAT_ID=-1001234567890
# STORAGE_CHAT_ID=-1001234567890

# –†–µ–∂–∏–º –≤—ã–¥–∞—á–∏ –≤–∏–¥–µ–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
# send (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ‚Äî –æ–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç –±–æ—Ç–∞ –ø–æ file_id (–º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å)
# copy ‚Äî –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ vault
VIDEO_DELIVERY_MODE=send
```

> `ALLOWED_USER_ID` / `ALLOWED_USER_IDS` –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞.

## –í—ã–¥–∞—á–∞ –≤–∏–¥–µ–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

- `VIDEO_DELIVERY_MODE=send` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ `send_video` –ø–æ `file_id` (fallback: `send_document`).
- `VIDEO_DELIVERY_MODE=copy` ‚Äî –≤–∫–ª—é—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π vault-flow (`copy_message`).
- Telegram –Ω–µ –¥–∞—ë—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∑–∞–ø—Ä–µ—Ç–∏—Ç—å —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–∏ –æ–±—ã—á–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ –±–æ—Ç–æ–º, –ø–æ—ç—Ç–æ–º—É –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º ‚Äî `send`.

## –ö–∞–∫ —Ç–µ–ø–µ—Ä—å –≤—ã–¥–∞–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø

1. –ê–¥–º–∏–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `/start`.
2. –ù–∞–∂–∏–º–∞–µ—Ç **üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏**.
3. –í—ã–±–∏—Ä–∞–µ—Ç **‚ûï –î–æ–±–∞–≤–∏—Ç—å**.
4. –ü–µ—Ä–µ–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ª—É—á—à–µ –≤—Å–µ–≥–æ forward-—Å–æ–æ–±—â–µ–Ω–∏–µ–º).
5. –í—ã–±–∏—Ä–∞–µ—Ç —Å—Ä–æ–∫ (7/30/90/365 –∏–ª–∏ –≤—Ä—É—á–Ω—É—é).

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã.



## –ú–æ–¥–µ–ª—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ

- –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ vault-–∫–∞–Ω–∞–ª–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ `videos`.
- –û—Å–Ω–æ–≤–Ω–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –∫–∞—Ç–∞–ª–æ–≥–∞: `(vault_chat_id, vault_message_id)`.
- `file_unique_id` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ –∞—Ç—Ä–∏–±—É—Ç —Ñ–∞–π–ª–∞ –∏ **–Ω–µ** —è–≤–ª—è–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –ø–æ–ª–µ–º.
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω–∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã —Ä–∞–∑–Ω—ã–º–∏ –ø–æ—Å—Ç–∞–º–∏ –≤ vault.

## –†–∞–∑–º–µ—â–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–ø–æ –≤–∞—à–µ–º—É —Å–µ—Ä–≤–µ—Ä—É)

–ß—Ç–æ–±—ã –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ø–∞–¥–∞–ª–∏ –≤ git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π `dancehall-bot`, –¥–µ—Ä–∂–∏—Ç–µ –∏—Ö **–Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ**:

- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –±–æ—Ç–∞: `/srv/dancehall-bot/repo/dancehall-bot`
- –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã: `/srv/dancehall-bot/repo/private`

–ü—Ä–∏–º–µ—Ä:

```bash
mkdir -p /srv/dancehall-bot/repo/private
mv /srv/dancehall-bot/repo/dancehall-bot/.env /srv/dancehall-bot/repo/private/.env
```

–ò –≤ systemd/compose –∑–∞–¥–∞–π—Ç–µ –ø—É—Ç–∏:

```env
DB_PATH=/srv/dancehall-bot/repo/private/dancehall.db
```

–¢–∞–∫–∂–µ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –º–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å env –∏–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:

```bash
set -a
source /srv/dancehall-bot/repo/private/.env
set +a
python /srv/dancehall-bot/repo/dancehall-bot/bot.py
```

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python bot.py
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

- `bot.py` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç –∏ –∫–æ–Ω—Ç–µ–Ω—Ç-—Ö–µ–Ω–¥–ª–µ—Ä—ã.
- `storage.py` ‚Äî SQLite —Å–ª–æ–π –¥–ª—è –≤–∏–¥–µ–æ.
- `storage_users.py` ‚Äî SQLite —Å–ª–æ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
- `access_control.py` ‚Äî —Ä–æ–ª–∏ –∏ env-–ø–∞—Ä—Å–∏–Ω–≥ –∞–¥–º–∏–Ω–æ–≤.
- `user_guards.py` ‚Äî reusable guards (`require_admin`, `require_member`).
- `admin_handlers.py` ‚Äî FSM –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `username` –∫–∞–∫ –∫–ª—é—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –í—Å–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω—ã.
- –ù–µ–ª—å–∑—è –±–∞–Ω–∏—Ç—å/—É–¥–∞–ª—è—Ç—å `ADMIN`.
- –ù–µ–ª—å–∑—è —Å–ª—É—á–∞–π–Ω–æ –±–∞–Ω–∏—Ç—å/—É–¥–∞–ª—è—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è.
- –í—Å–µ –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ stdout.
